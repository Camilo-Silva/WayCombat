<!-- ADMIN DASHBOARD -->
<div class="container-fluid py-4">
  <!-- Header del Dashboard -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h2 text-primary-blue mb-0">
            <i class="fas fa-tachometer-alt me-2"></i>Panel de Administración
          </h1>
          <p class="text-muted mb-0">Gestiona mixs, usuarios y permisos</p>
        </div>
        <div>
          <span class="badge bg-success fs-6">
            <i class="fas fa-shield-alt me-1"></i>Administrador
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Navegación por pestañas -->
  <div class="row mb-4">
    <div class="col-12">
      <ul class="nav nav-tabs nav-fill" role="tablist">
        <li class="nav-item" role="presentation">
          <button 
            class="nav-link" 
            [class.active]="activeTab === 'mixs'"
            (click)="setActiveTab('mixs')"
            type="button">
            <i class="fas fa-music me-2"></i>Gestión de Mixs
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button 
            class="nav-link" 
            [class.active]="activeTab === 'usuarios'"
            (click)="setActiveTab('usuarios')"
            type="button">
            <i class="fas fa-users me-2"></i>Usuarios Registrados
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button 
            class="nav-link" 
            [class.active]="activeTab === 'permisos'"
            (click)="setActiveTab('permisos')"
            type="button">
            <i class="fas fa-key me-2"></i>Asignación de Permisos
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Contenido de las pestañas -->
  <div class="tab-content">
    
    <!-- ========== PESTAÑA: GESTIÓN DE MIXS ========== -->
    <div *ngIf="activeTab === 'mixs'" class="tab-pane fade show active">
      
      <!-- Botón para crear nuevo mix -->
      <div class="row mb-4">
        <div class="col-12">
          <button 
            class="btn btn-way-primary btn-lg"
            (click)="startCreatingMix()"
            *ngIf="!isCreatingMix">
            <i class="fas fa-plus me-2"></i>Crear Nuevo Mix
          </button>
        </div>
      </div>

      <!-- Formulario de creación/edición de mix -->
      <div *ngIf="isCreatingMix" class="row mb-5">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-primary-blue text-white">
              <h5 class="mb-0">
                <i class="fas fa-edit me-2"></i>
                {{ editingMixId ? 'Editar Mix' : 'Crear Nuevo Mix' }}
              </h5>
            </div>
            <div class="card-body">
              <form [formGroup]="mixForm" (ngSubmit)="saveMix()">
                
                <!-- Información básica del mix -->
                <div class="row mb-3">
                  <div class="col-md-8">
                    <label class="form-label fw-bold">Título del Mix *</label>
                    <input 
                      type="text" 
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('titulo')"
                      formControlName="titulo"
                      placeholder="Ej: Mix Combat Principiantes">
                    <div class="invalid-feedback">{{ getFieldError('titulo') }}</div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label fw-bold">Estado</label>
                    <div class="form-check form-switch">
                      <input 
                        class="form-check-input" 
                        type="checkbox" 
                        formControlName="activo"
                        id="mixActivo">
                      <label class="form-check-label" for="mixActivo">
                        Activo
                      </label>
                    </div>
                  </div>
                </div>

                <div class="row mb-4">
                  <div class="col-12">
                    <label class="form-label fw-bold">Descripción *</label>
                    <textarea 
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('descripcion')"
                      formControlName="descripcion"
                      rows="3"
                      placeholder="Describe el contenido y nivel del mix..."></textarea>
                    <div class="invalid-feedback">{{ getFieldError('descripcion') }}</div>
                  </div>
                </div>

                <!-- Gestión de archivos -->
                <div class="mb-4">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-primary-blue mb-0">
                      <i class="fas fa-folder-open me-2"></i>Archivos del Mix
                    </h6>
                    <button 
                      type="button" 
                      class="btn btn-outline-primary btn-sm"
                      (click)="openArchivoModal()">
                      <i class="fas fa-plus me-1"></i>Agregar Archivo
                    </button>
                  </div>

                  <!-- Tabla compacta de archivos -->
                  <div *ngIf="archivosTemporales.length > 0" class="table-responsive">
                    <table class="table table-sm table-striped">
                      <thead class="table-dark">
                        <tr>
                          <th style="width: 5%;">#</th>
                          <th style="width: 25%;">Nombre</th>
                          <th style="width: 10%;">Tipo</th>
                          <th style="width: 40%;">URL</th>
                          <th style="width: 10%;">Estado</th>
                          <th style="width: 10%;">Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let archivo of archivosTemporales; let i = index">
                          <td>{{ i + 1 }}</td>
                          <td>
                            <small>{{ archivo.nombre }}</small>
                          </td>
                          <td>
                            <span class="badge" [ngClass]="archivo.tipo.toLowerCase() === 'audio' ? 'bg-info' : 'bg-warning'">
                              <i class="fas" [ngClass]="archivo.tipo.toLowerCase() === 'audio' ? 'fa-music' : 'fa-video'"></i>
                              {{ archivo.tipo }}
                            </span>
                          </td>
                          <td>
                            <small class="text-truncate d-block" style="max-width: 300px;" [title]="archivo.url">
                              {{ archivo.url }}
                            </small>
                          </td>
                          <td>
                            <span class="badge" [ngClass]="archivo.activo ? 'bg-success' : 'bg-secondary'">
                              {{ archivo.activo ? 'Activo' : 'Inactivo' }}
                            </span>
                          </td>
                          <td>
                            <div class="btn-group" role="group">
                              <button 
                                type="button" 
                                class="btn btn-outline-primary btn-xs"
                                (click)="editArchivoFromTable(i)"
                                title="Editar archivo">
                                <i class="fas fa-edit"></i>
                              </button>
                              <button 
                                type="button" 
                                class="btn btn-outline-danger btn-xs"
                                (click)="removeArchivoFromTable(i)"
                                title="Eliminar archivo">
                                <i class="fas fa-trash"></i>
                              </button>
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- Mensaje cuando no hay archivos -->
                  <div *ngIf="archivosTemporales.length === 0" class="text-center py-4 text-muted">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <p class="mb-0">No hay archivos agregados</p>
                    <small>Haz clic en "Agregar Archivo" para comenzar</small>
                  </div>
                </div>

                <!-- Botones de acción -->
                <div class="d-flex gap-2">
                  <button 
                    type="submit" 
                    class="btn btn-success"
                    [disabled]="isLoading">
                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                    <i class="fas fa-save me-2" *ngIf="!isLoading"></i>
                    {{ editingMixId ? 'Actualizar Mix' : 'Crear Mix' }}
                  </button>
                  <button 
                    type="button" 
                    class="btn btn-secondary"
                    (click)="cancelEdit()">
                    <i class="fas fa-times me-2"></i>Cancelar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de mixs existentes -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0 text-white">
                <i class="fas fa-list me-2"></i>Mixs Existentes ({{ mixs.length }})
              </h5>
              <span class="badge bg-light text-primary">Total: {{ mixs.length }}</span>
            </div>
            <div class="card-body p-0">
              
              <!-- Loading state -->
              <div *ngIf="isLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Cargando mixs...</p>
              </div>

              <!-- Lista de mixs -->
              <div *ngIf="!isLoading" class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>ID</th>
                      <th>Título</th>
                      <th>Descripción</th>
                      <th>Archivos</th>
                      <th>Estado</th>
                      <th>Fecha</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let mix of mixs">
                      <td>{{ mix.id }}</td>
                      <td>
                        <strong>{{ mix.titulo }}</strong>
                      </td>
                      <td>
                        <span class="text-muted">{{ mix.descripcion | slice:0:50 }}{{ mix.descripcion && mix.descripcion.length > 50 ? '...' : '' }}</span>
                      </td>
                      <td>
                        <span class="badge bg-secondary">{{ mix.archivos.length }} archivos</span>
                      </td>
                      <td>
                        <div class="form-check form-switch">
                          <input 
                            class="form-check-input" 
                            type="checkbox" 
                            [checked]="mix.activo"
                            (change)="toggleMixActivo(mix.id!)"
                            [id]="'switch' + mix.id">
                          <label class="form-check-label" [for]="'switch' + mix.id">
                            <span class="badge" [class.bg-success]="mix.activo" [class.bg-secondary]="!mix.activo">
                              {{ mix.activo ? 'Activo' : 'Inactivo' }}
                            </span>
                          </label>
                        </div>
                      </td>
                      <td>
                        <small class="text-muted">{{ mix.fechaCreacion | date:'dd/MM/yyyy' }}</small>
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <button 
                            class="btn btn-outline-primary" 
                            (click)="editMix(mix)"
                            title="Editar mix">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button 
                            class="btn btn-outline-danger" 
                            (click)="deleteMix(mix.id!)"
                            title="Eliminar mix">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Empty state -->
              <div *ngIf="!isLoading && mixs.length === 0" class="text-center py-5">
                <i class="fas fa-music fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay mixs creados</h5>
                <p class="text-muted">Comienza creando tu primer mix</p>
                <button class="btn btn-way-primary" (click)="startCreatingMix()">
                  <i class="fas fa-plus me-2"></i>Crear Primer Mix
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== PESTAÑA: USUARIOS REGISTRADOS ========== -->
    <div *ngIf="activeTab === 'usuarios'" class="tab-pane fade show active">
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fas fa-users me-2"></i>Usuarios Registrados ({{ usuariosFiltrados.length }})
              </h5>
              <span class="badge bg-info">Mostrando: {{ usuariosFiltrados.length }} / {{ usuarios.length }}</span>
            </div>

            <!-- Barra de búsqueda y filtros -->
            <div class="card-body border-bottom">
              <div class="row g-3 align-items-end">
                <!-- Búsqueda por nombre/email -->
                <div class="col-md-6">
                  <label for="searchInput" class="form-label fw-bold">
                    <i class="fas fa-search me-1"></i>Buscar usuario
                  </label>
                  <input 
                    id="searchInput"
                    type="text" 
                    class="form-control"
                    [(ngModel)]="searchText"
                    (input)="onSearchTextChange()"
                    placeholder="Buscar por nombre o email...">
                </div>

                <!-- Filtro por mixs asignados -->
                <div class="col-md-4">
                  <label for="filterSelect" class="form-label fw-bold">
                    <i class="fas fa-filter me-1"></i>Mixs asignados
                  </label>
                  <select 
                    id="filterSelect"
                    class="form-select"
                    [(ngModel)]="filterMixsAsignados"
                    (change)="onFilterMixsAsignadosChange()">
                    <option value="todos">Todos los usuarios</option>
                    <option value="con-mixs">Con mixs asignados</option>
                    <option value="sin-mixs">Sin mixs asignados</option>
                  </select>
                </div>

                <!-- Botón limpiar filtros -->
                <div class="col-md-2">
                  <button 
                    class="btn btn-outline-secondary w-100"
                    (click)="clearFilters()"
                    [disabled]="!searchText && filterMixsAsignados === 'todos'">
                    <i class="fas fa-times me-1"></i>Limpiar
                  </button>
                </div>
              </div>

              <!-- Estadísticas rápidas -->
              <div class="row mt-3" *ngIf="usuarios.length > 0">
                <div class="col-12">
                  <div class="d-flex gap-3 flex-wrap">
                    <small class="badge bg-primary">
                      <i class="fas fa-users me-1"></i>Total: {{ usuarios.length }}
                    </small>
                    <small class="badge bg-success">
                      <i class="fas fa-check me-1"></i>Activos: {{ usuariosActivos }}
                    </small>
                    <small class="badge bg-danger">
                      <i class="fas fa-pause me-1"></i>Inactivos: {{ usuariosInactivos }}
                    </small>
                    <small class="badge bg-info">
                      <i class="fas fa-music me-1"></i>Con mixs: {{ usuariosConMixs }}
                    </small>
                    <small class="badge bg-warning text-dark">
                      <i class="fas fa-user-minus me-1"></i>Sin mixs: {{ usuariosSinMixs }}
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-body p-0">
              
              <!-- Loading state -->
              <div *ngIf="isLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Cargando usuarios...</p>
              </div>

              <!-- Lista de usuarios -->
              <div *ngIf="!isLoading" class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>ID</th>
                      <th>Nombre</th>
                      <th>Email</th>
                      <th>Rol</th>
                      <th>Fecha Registro</th>
                      <th>Mixs Asignados</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let usuario of usuariosFiltrados" [class.table-danger]="!usuario.activo">
                      <td>{{ usuario.id }}</td>
                      <td>
                        <div class="d-flex align-items-center">
                          <i class="fas fa-user-circle me-2 text-primary"></i>
                          <strong>{{ usuario.nombre }}</strong>
                          <span *ngIf="!usuario.activo" class="badge bg-danger ms-2">Desactivado</span>
                        </div>
                      </td>
                      <td>{{ usuario.email }}</td>
                      <td>
                        <span 
                          class="badge"
                          [class.bg-warning]="usuario.rol === 'admin'"
                          [class.bg-primary]="usuario.rol === 'Usuario'">
                          {{ usuario.rol }}
                        </span>
                      </td>
                      <td>
                        <small class="text-muted">{{ usuario.fechaCreacion | date:'dd/MM/yyyy' }}</small>
                      </td>
                      <td>
                        <span class="badge bg-secondary">
                          {{ getPermisosActivosCount(usuario.id!) }} mixs
                        </span>
                      </td>
                      <td>
                        <span 
                          class="badge"
                          [class.bg-success]="usuario.activo"
                          [class.bg-danger]="!usuario.activo">
                          {{ usuario.activo ? 'Activo' : 'Inactivo' }}
                        </span>
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm" role="group">
                          <!-- Botón de activar/desactivar -->
                          <button 
                            class="btn"
                            [class.btn-outline-warning]="usuario.activo"
                            [class.btn-outline-success]="!usuario.activo"
                            [disabled]="usuario.rol === 'admin'"
                            (click)="toggleUsuarioActivo(usuario.id!)"
                            [title]="usuario.activo ? 'Desactivar usuario' : 'Activar usuario'">
                            <i class="fas" [class.fa-pause]="usuario.activo" [class.fa-play]="!usuario.activo"></i>
                          </button>
                          <!-- Botón de resetear contraseña -->
                          <button 
                            class="btn btn-outline-info"
                            [disabled]="usuario.rol === 'admin'"
                            (click)="confirmResetPassword(usuario)"
                            title="Resetear contraseña a 123456">
                            <i class="fas fa-key"></i>
                          </button>
                          <!-- Botón de eliminar -->
                          <button 
                            class="btn btn-outline-danger"
                            [disabled]="usuario.rol === 'admin'"
                            (click)="confirmDeleteUsuario(usuario)"
                            title="Eliminar usuario">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Empty state -->
              <div *ngIf="!isLoading && usuarios.length === 0" class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay usuarios registrados</h5>
                <p class="text-muted">Los usuarios aparecerán aquí cuando se registren</p>
              </div>

              <!-- No results after filtering -->
              <div *ngIf="!isLoading && usuarios.length > 0 && usuariosFiltrados.length === 0" class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No se encontraron usuarios</h5>
                <p class="text-muted">Intenta ajustar los filtros de búsqueda</p>
                <button class="btn btn-outline-primary" (click)="clearFilters()">
                  <i class="fas fa-times me-2"></i>Limpiar filtros
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== PESTAÑA: ASIGNACIÓN DE PERMISOS ========== -->
    <div *ngIf="activeTab === 'permisos'" class="tab-pane fade show active">
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-1 text-white">
                <i class="fas fa-key me-2"></i>Matriz de Permisos: Usuarios vs Mixs
              </h5>
              <small class="text-white-50">
                <i class="fas fa-info-circle me-1"></i>
                Haz clic en las casillas para otorgar o quitar acceso a los mixs
              </small>
            </div>
            <div class="card-body">
              
              <!-- Barra de búsqueda y filtros para matriz de permisos -->
              <div class="row mb-4 p-3 bg-light rounded">
                <div class="col-md-5">
                  <label for="searchPermisos" class="form-label fw-bold">
                    <i class="fas fa-search me-1"></i>Buscar Usuario
                  </label>
                  <input 
                    type="text" 
                    id="searchPermisos"
                    class="form-control" 
                    [(ngModel)]="searchTextPermisos"
                    (input)="onSearchTextPermisosChange()"
                    placeholder="Buscar por nombre o email...">
                </div>
                <div class="col-md-4">
                  <label for="filterMixsPermisos" class="form-label fw-bold">
                    <i class="fas fa-filter me-1"></i>Filtrar por Mixs
                  </label>
                  <select 
                    id="filterMixsPermisos"
                    class="form-select"
                    [(ngModel)]="filterMixsAsignadosPermisos"
                    (change)="onFilterMixsAsignadosPermisosChange()">
                    <option value="todos">Todos los usuarios</option>
                    <option value="con-mixs">Con mixs asignados</option>
                    <option value="sin-mixs">Sin mixs asignados</option>
                  </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                  <button 
                    class="btn btn-outline-secondary w-100"
                    (click)="clearFiltersPermisos()"
                    title="Limpiar filtros">
                    <i class="fas fa-times me-1"></i>Limpiar
                  </button>
                </div>
              </div>

              <!-- Loading state -->
              <div *ngIf="isLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Cargando permisos...</p>
              </div>

              <!-- Matriz de permisos -->
              <div *ngIf="!isLoading && usuariosFiltradosPermisos.length > 0 && mixs.length > 0" class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th class="sticky-column text-white">Usuario</th>
                      <th *ngFor="let mix of mixs" class="text-center text-white">
                        <div class="d-flex flex-column align-items-center">
                          <strong class="text-white">{{ mix.titulo }}</strong>
                          <small class="text-white-50">ID: {{ mix.id }}</small>
                        </div>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let usuario of usuariosFiltradosPermisos">
                      <td class="sticky-column fw-bold">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-user me-2"></i>
                          <div>
                            <div>{{ usuario.nombre }}</div>
                            <small class="text-muted">{{ usuario.email }}</small>
                          </div>
                        </div>
                      </td>
                      <td *ngFor="let mix of mixs" class="text-center position-relative">
                        <div class="permission-cell">
                          <!-- Indicador visual del estado -->
                          <div class="permission-indicator" [class.active]="hasPermiso(usuario.id!, mix.id!)">
                            <i class="fas" [class.fa-check-circle]="hasPermiso(usuario.id!, mix.id!)" 
                               [class.fa-times-circle]="!hasPermiso(usuario.id!, mix.id!)"></i>
                          </div>
                          <!-- Switch de control -->
                          <div class="form-check form-switch d-flex justify-content-center">
                            <input 
                              class="form-check-input" 
                              type="checkbox"
                              [checked]="hasPermiso(usuario.id!, mix.id!)"
                              (change)="toggleUsuarioMixPermiso(usuario.id!, mix.id!)"
                              [id]="'permiso_' + usuario.id + '_' + mix.id"
                              [title]="hasPermiso(usuario.id!, mix.id!) ? 'Clic para QUITAR acceso' : 'Clic para OTORGAR acceso'">
                            <label 
                              class="form-check-label visually-hidden" 
                              [for]="'permiso_' + usuario.id + '_' + mix.id">
                              {{ hasPermiso(usuario.id!, mix.id!) ? 'Quitar acceso' : 'Otorgar acceso' }} a {{ mix.titulo }} para {{ usuario.nombre }}
                            </label>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
                
                <!-- Leyenda explicativa -->
                <div class="mt-3 p-3 bg-light rounded">
                  <div class="row align-items-center">
                    <div class="col-md-8">
                      <h6 class="mb-2 text-primary">
                        <i class="fas fa-info-circle me-1"></i>Cómo usar esta tabla:
                      </h6>
                      <ul class="mb-0 small text-muted">
                        <li>Cada columna representa un <strong>Mix</strong> disponible</li>
                        <li>Cada fila representa un <strong>Usuario</strong> registrado</li>
                        <li>Haz clic en el <strong>switch</strong> para otorgar/quitar acceso</li>
                      </ul>
                    </div>
                    <div class="col-md-4 text-end">
                      <div class="d-flex justify-content-end align-items-center gap-3">
                        <div class="text-center">
                          <i class="fas fa-check-circle text-success fs-5"></i>
                          <br><small class="text-muted">Con acceso</small>
                        </div>
                        <div class="text-center">
                          <i class="fas fa-times-circle text-danger fs-5"></i>
                          <br><small class="text-muted">Sin acceso</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Empty state para filtros sin resultados -->
              <div *ngIf="!isLoading && usuarios.length > 0 && usuariosFiltradosPermisos.length === 0" class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No se encontraron usuarios</h5>
                <p class="text-muted">No hay usuarios que coincidan con los filtros aplicados</p>
                <button class="btn btn-outline-primary" (click)="clearFiltersPermisos()">
                  <i class="fas fa-times me-2"></i>Limpiar filtros
                </button>
              </div>

              <!-- Empty states -->
              <div *ngIf="!isLoading && usuarios.length === 0" class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay usuarios para asignar permisos</h5>
                <p class="text-muted">Primero necesitas tener usuarios registrados</p>
              </div>

              <div *ngIf="!isLoading && mixs.length === 0" class="text-center py-5">
                <i class="fas fa-music fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay mixs para asignar</h5>
                <p class="text-muted">Primero crea algunos mixs en la pestaña "Gestión de Mixs"</p>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ============================================
     MODAL DE CONFIRMACIÓN PARA ELIMINAR USUARIO
     ============================================ -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteUserModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <i class="fas fa-user-times fa-3x text-danger mb-3"></i>
          <h6 class="fw-bold">⚠️ ADVERTENCIA: Esta acción es irreversible</h6>
        </div>
        
        <div *ngIf="userToDelete" class="alert alert-warning">
          <strong>Usuario a eliminar:</strong><br>
          <i class="fas fa-user me-2"></i>{{ userToDelete.nombre }}<br>
          <i class="fas fa-envelope me-2"></i>{{ userToDelete.email }}<br>
          <i class="fas fa-tag me-2"></i>{{ userToDelete.rol }}
        </div>

        <p class="text-muted">
          Al eliminar este usuario:
        </p>
        <ul class="text-muted">
          <li>Se perderán todos sus datos permanentemente</li>
          <li>Se eliminarán todos sus permisos de acceso a mixs</li>
          <li>No podrá recuperar su cuenta</li>
        </ul>

        <div class="mt-3">
          <label for="deleteConfirmationInput" class="form-label fw-bold text-danger">
            Para confirmar, escribe <code>ELIMINAR</code> en el campo de abajo:
          </label>
          <input 
            id="deleteConfirmationInput"
            type="text" 
            class="form-control" 
            [(ngModel)]="deleteConfirmationText"
            placeholder="Escribe ELIMINAR para confirmar"
            autocomplete="off">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelDeleteUsuario()">
          <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-danger"
          [disabled]="deleteConfirmationText !== 'ELIMINAR'"
          (click)="executeDeleteUsuario()">
          <i class="fas fa-trash me-2"></i>Eliminar Usuario
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ============================================
     MODAL PARA AGREGAR/EDITAR ARCHIVO
     ============================================ -->
<div class="modal fade" [class.show]="showArchivoModal" [style.display]="showArchivoModal ? 'block' : 'none'" 
     tabindex="-1" id="archivoModal" *ngIf="showArchivoModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas fa-file-plus me-2"></i>
          {{ editingArchivoIndex !== null ? 'Editar Archivo' : 'Agregar Nuevo Archivo' }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeArchivoModal()"></button>
      </div>
      
      <div class="modal-body">
        <form [formGroup]="archivoModalForm" (ngSubmit)="saveArchivoFromModal()">
          <div class="row">
            <!-- Nombre del archivo -->
            <div class="col-md-8 mb-3">
              <label for="nombreArchivoModal" class="form-label fw-bold">
                <i class="fas fa-file me-1"></i>Nombre del Archivo *
              </label>
              <input 
                id="nombreArchivoModal"
                type="text" 
                class="form-control"
                [class.is-invalid]="archivoModalForm.get('nombre')?.invalid && archivoModalForm.get('nombre')?.touched"
                formControlName="nombre"
                placeholder="Ej: Mix_Principiantes.mp3">
              <div class="invalid-feedback" *ngIf="archivoModalForm.get('nombre')?.invalid && archivoModalForm.get('nombre')?.touched">
                El nombre del archivo es requerido
              </div>
            </div>

            <!-- Tipo de archivo -->
            <div class="col-md-4 mb-3">
              <label for="tipoArchivoModal" class="form-label fw-bold">
                <i class="fas fa-tags me-1"></i>Tipo *
              </label>
              <select id="tipoArchivoModal" class="form-select" formControlName="tipo">
                <option value="audio">
                  <i class="fas fa-music"></i> Audio (MP3)
                </option>
                <option value="video">
                  <i class="fas fa-video"></i> Video (MP4)
                </option>
              </select>
            </div>
          </div>

          <div class="row">
            <!-- URL del archivo -->
            <div class="col-12 mb-3">
              <label for="urlArchivoModal" class="form-label fw-bold">
                <i class="fas fa-link me-1"></i>URL del Archivo *
              </label>
              <div class="input-group">
                <input 
                  id="urlArchivoModal"
                  type="url" 
                  class="form-control"
                  [class.is-invalid]="archivoModalForm.get('url')?.invalid && archivoModalForm.get('url')?.touched"
                  formControlName="url"
                  placeholder="URL de Google Drive: https://drive.google.com/file/d/[ID]/view">
                <button 
                  type="button" 
                  class="btn btn-outline-secondary"
                  (click)="convertDriveUrlInModal()"
                  title="Convertir URL de Drive a formato directo">
                  <i class="fas fa-magic me-1"></i>Convertir
                </button>
              </div>
              <div class="invalid-feedback" *ngIf="archivoModalForm.get('url')?.invalid && archivoModalForm.get('url')?.touched">
                Se requiere una URL válida (debe comenzar con http:// o https://)
              </div>
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>
                <strong>Google Drive:</strong> Pega la URL de compartir y haz clic en "Convertir" |
                <strong>YouTube:</strong> URL completa del video
              </div>
            </div>
          </div>

          <!-- Ayuda visual para Google Drive -->
          <div class="row mb-3">
            <div class="col-12">
              <button 
                type="button" 
                class="btn btn-link btn-sm p-0"
                (click)="toggleDriveHelp()"
                [attr.aria-expanded]="showDriveHelp">
                <i class="fas fa-question-circle me-1"></i>¿Cómo obtener URLs de Google Drive?
              </button>
              
              <div *ngIf="showDriveHelp" class="alert alert-info mt-2">
                <h6><i class="fab fa-google-drive me-2"></i>Pasos para Google Drive:</h6>
                <ol class="mb-2">
                  <li>Sube tu archivo a Google Drive</li>
                  <li>Haz clic derecho → "Obtener enlace"</li>
                  <li>Cambia a "Cualquier persona con el enlace"</li>
                  <li>Copia la URL completa aquí</li>
                  <li>Haz clic en "Convertir" para transformar automáticamente</li>
                </ol>
                <small class="text-muted">
                  <i class="fas fa-lightbulb me-1"></i>
                  La URL se convertirá automáticamente al formato directo para reproducción
                </small>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Descripción -->
            <div class="col-md-8 mb-3">
              <label for="descripcionArchivoModal" class="form-label">
                <i class="fas fa-comment-alt me-1"></i>Descripción
              </label>
              <textarea 
                id="descripcionArchivoModal"
                class="form-control"
                formControlName="descripcion"
                rows="3"
                placeholder="Descripción opcional del archivo..."></textarea>
            </div>

            <!-- Estado -->
            <div class="col-md-4 mb-3">
              <label for="estadoArchivoModal" class="form-label fw-bold">
                <i class="fas fa-toggle-on me-1"></i>Estado
              </label>
              <div class="form-check form-switch mt-2">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  formControlName="activo"
                  id="archivoActivoModal">
                <label class="form-check-label" for="archivoActivoModal">
                  <span class="badge" [ngClass]="archivoModalForm.get('activo')?.value ? 'bg-success' : 'bg-secondary'">
                    {{ archivoModalForm.get('activo')?.value ? 'Activo' : 'Inactivo' }}
                  </span>
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeArchivoModal()">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-primary"
          (click)="saveArchivoFromModal()"
          [disabled]="archivoModalForm.invalid">
          <i class="fas fa-save me-1"></i>
          {{ editingArchivoIndex !== null ? 'Actualizar' : 'Agregar' }} Archivo
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop del modal -->
<div class="modal-backdrop fade" [class.show]="showArchivoModal" *ngIf="showArchivoModal" 
     (click)="closeArchivoModal()" (keydown.escape)="closeArchivoModal()"></div>