<!-- Mi Cuenta Component -->
<div class="container mt-4">
  
  <!-- Si no está autenticado -->
  <div *ngIf="!isAuthenticated" class="text-center">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="alert alert-info">
          <h4 class="alert-heading">Acceso Requerido</h4>
          <p>Debes iniciar sesión para acceder a tu cuenta.</p>
          <hr>
          <p class="mb-0">
            <a routerLink="/auth" class="btn btn-primary">
              <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión
            </a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Si está autenticado -->
  <div *ngIf="isAuthenticated && currentUser" class="row">
    
    <!-- Header -->
    <div class="col-12 mb-4">
      <div class="bg-primary-blue text-white rounded-3 p-4 text-center">
        <h1 class="mb-3 text-white">
          <i class="fas fa-user-circle me-3 text-white"></i>Mi Cuenta
        </h1>
        <p class="mb-0">Gestiona tu información personal y configuración de seguridad</p>
      </div>
    </div>

    <!-- Información del perfil -->
    <div class="col-md-6 mb-4">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-header bg-light">
          <h3 class="card-title mb-0 text-dark">
            <i class="fas fa-user text-primary me-2"></i>Información Personal
          </h3>
        </div>
        <div class="card-body">
          
          <!-- Nombre -->
          <div class="mb-3">
            <label for="nombre" class="form-label">Nombre</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-user"></i>
              </span>
              <input 
                type="text" 
                class="form-control" 
                id="nombre"
                [(ngModel)]="editedUserName"
                [readonly]="!editingProfile"
                [class.form-control]="!editingProfile"
                [class.form-control-editable]="editingProfile"
                placeholder="Ingrese su nombre">
            </div>
          </div>

          <!-- Email -->
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-envelope"></i>
              </span>
              <input 
                type="email" 
                class="form-control" 
                id="email"
                [value]="currentUser?.email || ''"
                readonly>
            </div>
          </div>

          <!-- Rol -->
          <div class="mb-3">
            <label for="rol" class="form-label">Rol</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-shield-alt"></i>
              </span>
              <input 
                type="text" 
                class="form-control" 
                id="rol"
                [value]="currentUser?.rol || 'Usuario'"
                readonly>
            </div>
          </div>

          <!-- Fecha de registro -->
          <div class="mb-3">
            <label for="fechaRegistro" class="form-label">Fecha de Registro</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-calendar"></i>
              </span>
              <input 
                type="text" 
                class="form-control" 
                id="fechaRegistro"
                [value]="currentUser?.fechaCreacion | date:'dd/MM/yyyy'"
                readonly>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Cambiar contraseña -->
    <div class="col-md-6 mb-4">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-header bg-light">
          <h3 class="card-title mb-0 text-dark">
            <i class="fas fa-key text-warning me-2"></i>Seguridad
          </h3>
        </div>
        <div class="card-body">
          
          <form #passwordForm="ngForm" (ngSubmit)="changePassword()">
            
            <!-- Contraseña actual -->
            <div class="mb-3">
              <label for="currentPassword" class="form-label">Contraseña Actual</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-lock"></i>
                </span>
                <input 
                  [type]="showCurrentPassword ? 'text' : 'password'"
                  class="form-control" 
                  id="currentPassword"
                  name="currentPassword"
                  [(ngModel)]="passwordData.currentPassword"
                  required
                  placeholder="Ingresa tu contraseña actual">
                <button 
                  class="btn btn-outline-secondary" 
                  type="button"
                  (click)="togglePasswordVisibility('current')">
                  <i [class.fas]="true" [class.fa-eye]="!showCurrentPassword" [class.fa-eye-slash]="showCurrentPassword"></i>
                </button>
              </div>
            </div>

            <!-- Nueva contraseña -->
            <div class="mb-3">
              <label for="newPassword" class="form-label">Nueva Contraseña</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-key"></i>
                </span>
                <input 
                  [type]="showNewPassword ? 'text' : 'password'"
                  class="form-control" 
                  id="newPassword"
                  name="newPassword"
                  [(ngModel)]="passwordData.newPassword"
                  required
                  minlength="6"
                  placeholder="Mínimo 6 caracteres">
                <button 
                  class="btn btn-outline-secondary" 
                  type="button"
                  (click)="togglePasswordVisibility('new')">
                  <i [class.fas]="true" [class.fa-eye]="!showNewPassword" [class.fa-eye-slash]="showNewPassword"></i>
                </button>
              </div>
              <small class="text-muted">La contraseña debe tener al menos 6 caracteres</small>
            </div>

            <!-- Confirmar nueva contraseña -->
            <div class="mb-4">
              <label for="confirmPassword" class="form-label">Confirmar Nueva Contraseña</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-key"></i>
                </span>
                <input 
                  [type]="showConfirmPassword ? 'text' : 'password'"
                  class="form-control" 
                  id="confirmPassword"
                  name="confirmPassword"
                  [(ngModel)]="passwordData.confirmPassword"
                  required
                  placeholder="Repite la nueva contraseña">
                <button 
                  class="btn btn-outline-secondary" 
                  type="button"
                  (click)="togglePasswordVisibility('confirm')">
                  <i [class.fas]="true" [class.fa-eye]="!showConfirmPassword" [class.fa-eye-slash]="showConfirmPassword"></i>
                </button>
              </div>
              <div 
                class="text-danger mt-1" 
                *ngIf="passwordData.newPassword && passwordData.confirmPassword && passwordData.newPassword !== passwordData.confirmPassword">
                <i class="fas fa-exclamation-triangle me-1"></i>Las contraseñas no coinciden
              </div>
            </div>

            <!-- Botones -->
            <div class="d-grid gap-2">
              <button 
                type="submit" 
                class="btn btn-warning"
                [disabled]="!passwordForm.form.valid || passwordData.newPassword !== passwordData.confirmPassword || isChangingPassword">
                <i class="fas fa-save me-2" *ngIf="!isChangingPassword"></i>
                <div class="spinner-border spinner-border-sm me-2" *ngIf="isChangingPassword" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                {{ isChangingPassword ? 'Cambiando...' : 'Cambiar Contraseña' }}
              </button>
              <button 
                type="button" 
                class="btn btn-secondary"
                (click)="resetPasswordForm()"
                [disabled]="isChangingPassword">
                <i class="fas fa-undo me-2"></i>Limpiar Formulario
              </button>
            </div>

          </form>
          
        </div>
      </div>
    </div>

    <!-- Acciones de cuenta -->
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-light">
          <h3 class="card-title mb-0 text-dark">
            <i class="fas fa-cogs text-success me-2"></i>Acciones de Cuenta
          </h3>
        </div>
        <div class="card-body">
          <div class="row">
            
            <!-- Cerrar sesión -->
            <div class="col-md-6 mb-3">
              <div class="d-grid">
                <button 
                  type="button" 
                  class="btn btn-outline-danger"
                  (click)="logout()">
                  <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                </button>
              </div>
            </div>
            
            <!-- Botones de acción del perfil -->
            <div class="col-md-6 mb-3" *ngIf="!editingProfile">
              <div class="d-grid">
                <button 
                  type="button" 
                  class="btn btn-outline-primary"
                  (click)="toggleEditProfile()"
                  title="Editar nombre de perfil">
                  <i class="fas fa-edit me-2"></i>Editar Perfil
                </button>
              </div>
            </div>

            <!-- Botones guardar/cancelar cuando está editando -->
            <div class="col-md-12 mb-3" *ngIf="editingProfile">
              <div class="row">
                <div class="col-md-6">
                  <div class="d-grid">
                    <button 
                      type="button" 
                      class="btn btn-success"
                      (click)="updateProfile()"
                      [disabled]="isUpdatingProfile || !editedUserName.trim()"
                      title="Guardar cambios">
                      <div class="spinner-border spinner-border-sm me-2" *ngIf="isUpdatingProfile" aria-hidden="true"></div>
                      <i class="fas fa-save me-2" *ngIf="!isUpdatingProfile"></i>
                      {{ isUpdatingProfile ? 'Guardando...' : 'Guardar' }}
                    </button>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="d-grid">
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary"
                      (click)="toggleEditProfile()"
                      [disabled]="isUpdatingProfile"
                      title="Cancelar edición">
                      <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
          </div>
        </div>
      </div>
    </div>

  </div>

</div>

<!-- Toast notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;" *ngIf="showToast">
  <div class="toast show" role="alert">
    <div class="toast-header">
      <i [class.fas]="true" 
         [class.fa-check-circle]="toastType === 'success'" 
         [class.fa-exclamation-circle]="toastType === 'error'"
         [class.text-success]="toastType === 'success'" 
         [class.text-danger]="toastType === 'error'" 
         class="me-2"></i>
      <strong class="me-auto">{{ toastType === 'success' ? 'Éxito' : 'Error' }}</strong>
      <button type="button" class="btn-close" (click)="hideToast()"></button>
    </div>
    <div class="toast-body">
      {{ toastMessage }}
    </div>
  </div>
</div>
